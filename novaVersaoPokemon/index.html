<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="flip.css">
    <link rel="stylesheet" href="mudarCorClasse.css">
    <title>Pokemons</title>
</head>

<body>
    <header>
        <h1 id="titulo">POKEMONS</h1>
    </header>
    <main>

        <button onclick="iniciarDuelo()">Duelo</button>

        <img src="assets/icon/brilho.png" alt="" id="modoClaro">
        <section id="principal">


        </section>

        <div id="pagination">

            <ul id="paginationList">
                <li id="seeLess"><button id="btnVejaMenos" onclick="vejaMenos()"><<</button>
                </li>
                <li class="page"><button class="btnPage"></button></li>
                <li class="page"><button class="btnPage"></button></li>
                <li class="page"><button class="btnPage"></button></li>
                <li class="page"><button class="btnPage"></button></li>
                <li class="page"><button class="btnPage"></button></li>
                <li id="seeMore"><button id="btnVejaMais" onclick="vejaMais()">>></button></li>
            </ul>
        </div>
        <a href="pokedex.html">
            <img src="assets/icon/pokebola.png" alt="">
        </a>
    </main>

    <script src="script.js"></script>

    <script>

        const storedArray = sessionStorage.getItem('arrayPokemons');
        let arrayPokemons = storedArray ? JSON.parse(storedArray) : [];
        const storedArray1 = sessionStorage.getItem('pokedex');
        const arrayPokedex = storedArray1 ? JSON.parse(storedArray1) : [];
        let page = 0

        let offset = 0;
        const limit = 20;
        const pageNumberElement = document.getElementById('pageNumber');

        function iniciar() {
            if (arrayPokemons.length === 0) {
                buscarInformacoes(offset);
            } else {
                criarDivPokemons();
            }
        }
        iniciar();
        atualizaBotoes()

        function buscarInformacoes(offset) {
            const principal = document.getElementById("principal");
            console.log(offset)
            principal.innerHTML = ("")
            arrayPokemons = []

            fetch(`https://pokeapi.co/api/v2/pokemon/?limit=${limit}&offset=${offset}`)
                .then(response => response.json())
                .then(function (json) {
                    const pokemonsData = json.results;
                    console.log(pokemonsData)

                    for (let index = 0; index < 20; index++) {
                        const pokemon = pokemonsData[index];
                        const urlDetalhes = pokemon.url;
                        fetch(urlDetalhes)
                            .then(response => response.json())
                            .then(function (pokemonData) {

                                const id = pokemonData.id;
                                const nomePokemon = pokemonData.name;
                                const imgFrente = pokemonData.sprites.versions['generation-v']['black-white'].animated.front_default;
                                const imgCostas = pokemonData.sprites.versions['generation-v']['black-white'].animated.back_default;

                                const tipos = pokemonData.types.map(tipo => tipo.type.name);
                                const estatisticas = pokemonData.stats.map(stat => {
                                    return {
                                        nome: stat.stat.name,
                                        valor: stat.base_stat
                                    };
                                });
                                const moves = pokemonData.moves.slice(0, 5).map(move => move.move.name);

                                addPokemon(id, nomePokemon, imgFrente, imgCostas, tipos, estatisticas, moves);
                            })
                            .catch(err => console.log('Erro ' + err));
                    }


                })
                .catch(err => console.log('Erro ' + err));
        }

        function paginar(offSetPaginar) {

            if (offSetPaginar < 0) {
                offset = 0;
            }

            console.log(`offset pg = ${offSetPaginar}`)
            console.log(`offset script = ${offset}`)


            if(offset == offSetPaginar  ){
                return
            }

            offset = offSetPaginar

            console.log(`offset novo = ${offset}`)


            buscarInformacoes(offSetPaginar)
            criarDivPokemons()
        }

        function atualizaBotoes() {
            let setId = page
            let btnId = page

            let pageLi = document.getElementsByClassName("page")
            console.log(pageLi)

            for (let index = 0; index < pageLi.length; index++) {
                pageLi[index].id = `${setId}`
                setId += 1
            }

            console.log(pageLi)

            let btnPage = document.getElementsByClassName("btnPage")
            for (let index = 0; index < btnPage.length; index++) {
                btnPage[index].innerHTML = `${btnId + 1}`
                btnPage[index].setAttribute('onclick', `paginar(${btnId * 20})`)
                btnId += 1
            }
        }

        function vejaMais() {
            page = page + 5
            atualizaBotoes()
        }

        function vejaMenos() {
            if (page < 1) {
                return
            }
            page = page - 5

            atualizaBotoes()
        }

        function addPokemon(id, nomePokemon, imgFrente, imgCostas, tipos, estatisticas, moves) {
            const poke = {
                id: id,
                nome: nomePokemon,
                imgFrente: imgFrente,
                imgCostas: imgCostas,
                tipo: tipos,
                stats: estatisticas,
                moves: moves
            }
            arrayPokemons.push(poke);


            arrayPokemons.sort((a, b) => a.id - b.id);


            sessionStorage.setItem('arrayPokemons', JSON.stringify(arrayPokemons));
            criarDivPokemons()
            console.log(`Pokemon "${poke.nome}" adicionado à lista.`);
        }

        function addPokedex(id, nomePokemon, imgFrente, imgCostas, tipos, estatisticas, moves) {
            const pokemon = {
                id: id,
                nome: nomePokemon,
                imgFrente: imgFrente,
                imgCostas: imgCostas,
                tipo: tipos,
                stats: estatisticas,
                moves: moves
            };

            arrayPokedex.push(pokemon);
            removerPokemon(id);

            sessionStorage.setItem('pokedex', JSON.stringify(arrayPokedex));
            sessionStorage.setItem('arrayPokemons', JSON.stringify(arrayPokemons));

            removerDiv(pokemon);
            console.log(`Pokemon "${pokemon.nome}" adicionado à Pokedex.`);
        }

        function criarDivPokemons() {
            limpa()
            const principal = document.getElementById('principal');
            principal.innerHTML = ''
            filtra()
            arrayPokemons.forEach(pokemon => {
                createElements(pokemon, 'index');
            });
        }

        function filtra(){

            for (let index = 0; index < arrayPokedex.length; index++) {
                const pokemonPokedex = arrayPokedex[index];
                for (let j = 0; j < arrayPokemons.length; j++) {
                    const pokemon = arrayPokemons[j];
                    if(pokemon.id === pokemonPokedex.id){
                        arrayPokemons.splice(j, 1)
                    }
                }
                
            }

        }

        function removerPokemon(id) {
            const index = arrayPokemons.findIndex(pokemon => pokemon.id === id);

            if (index !== -1) {
                arrayPokemons.splice(index, 1);
                sessionStorage.setItem('arrayPokemons', JSON.stringify(arrayPokemons));

                console.log(`Pokemon com ID ${id} removido da lista.`);
            } else {
                console.error(`Pokemon com ID ${id} não encontrado na lista.`);
            }
        }

        function removerDiv(poke) {
            const divRemover = document.getElementById(`pokemon-${poke.id}`);
            if (divRemover) {
                divRemover.remove();
                console.log(`Div do Pokemon "${poke.nome}" removida.`);
            } else {
                console.error(`Div do Pokemon "${poke.nome}" não encontrada.`);
            }
        }

        function limpa() {
            let divs = document.getElementsByClassName('flipCard')
            for (let index = 0; index < divs.length; index++) {
                const element = divs[index];
                element = null
            }
        }

        function iniciarDuelo() {
            const pokemon1 = prompt("Escolha o ID do primeiro Pokémon:");
            const adversarioId = prompt("Escolha o ID do Pokémon adversário:");

            const pokemonUsuario = arrayPokemons.find(p => p.id === parseInt(pokemon1));
            const pokemonAdversario = arrayPokemons.find(p => p.id === parseInt(adversarioId));

            if (!pokemonUsuario || !pokemonAdversario) {
                alert('IDs inválidos');
                return;
            }

            alert(`Começou!\n\n${pokemonUsuario.nome} vs. ${pokemonAdversario.nome}`);

            const resultadoDuelo = calcularVencedor(pokemonUsuario.id, pokemonAdversario.id);

            alert(`Resultado do duelo:\n\n${pokemonUsuario.nome} ${resultadoDuelo} ${pokemonAdversario.nome}`);
        }

        function calcularVencedor(idUsuario, adversarioId) {
            const pokemonUsuario = arrayPokemons.find(p => p.id === idUsuario);

            const idAdversario = arrayPokemons.find(p => p.id === adversarioId)

            const poderUsuario = pokemonUsuario.stats.reduce((total, stat) => total + stat.valor, 0);
            const poderAdversario = idAdversario.stats.reduce((total, stat) => total + stat.valor, 0);

            console.log('Poder do usuário: ' + poderUsuario)
            console.log('Poder do adversário: ' + poderAdversario)

            if (poderUsuario > poderAdversario) {
                return 'vence contra';
            } else if (poderUsuario < poderAdversario) {
                return 'perde para';
            } else {
                return 'empata com';
            }
        }

        function criaDetalhes(pokemonId) {
            const divDetalhesPokemon = document.getElementById(`divDetalhes-${pokemonId}`);
            const arrayPokemonsArmazenado = sessionStorage.getItem('arrayPokemons');
            const arrayPokemons = arrayPokemonsArmazenado ? JSON.parse(arrayPokemonsArmazenado) : [];
            const pokemon = arrayPokemons.find(p => p.id === parseInt(pokemonId));
            divDetalhesPokemon.innerHTML = `
        <h2>${pokemon.nome}</h2>
        <div class="container-detalhes">
            <div class="tipo-e-ataque">
                <h3>Tipo(s):</h3>
                <ul>
                    ${pokemon.tipo.map(tipo => `<li>${tipo.toUpperCase()}</li>`).join('')}
                </ul>
                <h3>Moves:</h3>
                <ul>
                    ${pokemon.moves.map(move => `<li>${move.toUpperCase()}</li>`).join('')}
                </ul>
            </div>
            <div class="stats">
                <h3>Estatísticas:</h3>
                <ul>
                    ${pokemon.stats.map(stat => `<li>${stat.nome.toUpperCase()} - ${stat.valor}</li>`).join('')}
                </ul>
                <button id="detalhesBtn" onclick = 'verDetalhes(${pokemonId})'>
                <a href='detalhes.html?id=${pokemon.id}'>
                Ver Mais
                </a>
                </button>
                <button id="detalhesBtn" onclick="voltaCard(${pokemonId})">Voltar</button>
            </div>
        </div>
    `;
        }
        
        const img = document.getElementById('modoClaro')
        let estado = true

        img.addEventListener('click', function () {

            if (estado) {
                document.querySelector('main').style.backgroundColor = 'rgb(2, 6, 23)'
                document.querySelector('header').style.backgroundColor = 'rgb(2, 6, 23)'
                document.getElementById('titulo').style.color = 'white'
                img.src = './assets/icon/brilho.png'
            } else {
                
                document.querySelector('main').style.backgroundColor = 'white';
                document.querySelector('header').style.backgroundColor  = 'white';
                document.getElementById('titulo').style.color = 'black'
              
                img.src = './assets/icon/modo-escuro.png'
                
            }

                estado = !estado
        })

    </script>

</body>

</html>